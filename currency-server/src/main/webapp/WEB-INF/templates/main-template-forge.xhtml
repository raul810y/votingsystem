<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://java.sun.com/jsf/html"
      xmlns:o="http://omnifaces.org/ui"
      xmlns:ui="http://java.sun.com/jsf/facelets">
<h:head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <link rel="shortcut icon" type="image/png" href="#{request.contextPath}/res/img/icon_16/fa-money.png" />
    <title>#{msg.currencyLbl}</title>
    <link href="#{request.contextPath}/res/gtl/vendors/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet"/>
    <link href="#{request.contextPath}/res/gtl/vendors/font-awesome/css/font-awesome.min.css" rel="stylesheet"/>
    <script src="#{request.contextPath}/res/gtl/vendors/jquery/dist/jquery.min.js"></script>
    <!-- FastClick -->
    <script src="#{request.contextPath}/res/gtl/vendors/fastclick/lib/fastclick.js"></script>
    <script src="#{request.contextPath}/res/gtl/vendors/bootstrap/dist/js/bootstrap.min.js"></script>
    <script src="#{request.contextPath}/res/gtl/vendors/fastclick/lib/fastclick.js"></script>
    <script src="#{request.contextPath}/res/gtl/vendors/nprogress/nprogress.js"></script>
    <script src="#{request.contextPath}/res/gtl/vendors/validator/validator.min.js"></script>
    <link href="#{request.contextPath}/res/css/gl-custom.css" rel="stylesheet"/>

    <script type="text/javascript" src="#{request.contextPath}/res/js/utils_js.vsp"></script>
    <script type="text/javascript" src="#{request.contextPath}/res/js/utils.js"></script>

    <script type="text/javascript" src="#{request.contextPath}/res/forge/js/util.js"></script>
    <script type="text/javascript" src="#{request.contextPath}/res/forge/js/oids.js"></script>
    <script type="text/javascript" src="#{request.contextPath}/res/forge/js/asn1.js"></script>
    <script type="text/javascript" src="#{request.contextPath}/res/forge/js/pki.js"></script>
    <script type="text/javascript" src="#{request.contextPath}/res/forge/js/sha256.js"></script>
    <script type="text/javascript" src="#{request.contextPath}/res/forge/js/pkcs1.js"></script>
    <script type="text/javascript" src="#{request.contextPath}/res/forge/js/sha1.js"></script>
    <script type="text/javascript" src="#{request.contextPath}/res/forge/js/jsbn.js"></script>
    <script type="text/javascript" src="#{request.contextPath}/res/forge/js/rsa.js"></script>
    <script type="text/javascript" src="#{request.contextPath}/res/forge/js/x509.js"></script>
    <script type="text/javascript" src="#{request.contextPath}/res/forge/js/cipher.js"></script>
    <script type="text/javascript" src="#{request.contextPath}/res/forge/js/cipherModes.js"></script>
    <script type="text/javascript" src="#{request.contextPath}/res/forge/js/aes.js"></script>
    <script type="text/javascript" src="#{request.contextPath}/res/forge/js/prng.js"></script>
    <script type="text/javascript" src="#{request.contextPath}/res/forge/js/random.js"></script>
    <script type="text/javascript" src="#{request.contextPath}/res/js/forge/forge_pkcs7.js"></script>
    <script type="text/javascript" src="#{request.contextPath}/res/js/forge/forge_pkcs7asn1.js"></script>
    <script type="text/javascript" src="#{request.contextPath}/res/forge/js/pem.js"></script>
    <script type="text/javascript" src="#{request.contextPath}/res/forge/js/forge.js"></script>
    <script type="text/javascript" src="#{request.contextPath}/res/js/forge-utils.js"></script>

    <ui:insert name="head" />
</h:head>
<h:body class="nav-md">
    <!-- Large modal -->
    <div id="alertDialog" class="modal fade" tabindex="-1" role="dialog" aria-hidden="true" style="z-index: 10000;">
        <div class="modal-dialog">
            <div class="modal-content" style="text-align: center;">
                <div class="modal-header">
                    <button type="button" class="close custom-button" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">
                        <i class="fa fa-times"></i>
                    </span>
                    </button>
                    <h3 class="modal-title" id="alertCaption" style="color:#b71c1c;"></h3>
                </div>
                <div id="alertDialogQRImgDiv" style="margin: 0 auto; text-align: center; display: none;padding: 0 0 15px 0;">
                    <div id="alertDialogQRId" style="font-size: 1.8em;color: #3a8287;"></div>
                    <img id="alertDialogQRImg" src=""/>
                </div>
                <div id="alertDialogMsgDiv" class="modal-body" style="font-size: 1.2em; display: block; margin-right: 20px;word-wrap: break-word;">
                    <p id="alertMessage"></p>
                </div>
            </div>
        </div>
    </div>

    <div class="container body">
        <div class="main_container">
            <div class="col-md-3 left_col">
                <div class="left_col scroll-view">
                    <div class="navbar nav_title">
                        <a href="#{request.contextPath}/index.xhtml" class="site_title" style="margin: 5px 0 0 0;"><i class="fa fa-money"></i>
                            <span style="margin: 10px 0 0 0;">#{msg.currencyLbl}</span>
                        </a>
                    </div>
                    <div class="clearfix"></div>
                    <!-- sidebar menu -->
                    <div id="sidebar-menu" class="main_menu_side hidden-print main_menu">
                        <div class="menu_section">
                            <ul class="nav side-menu">
                                <li>
                                    <a href="#{request.contextPath}/election/elections.xhtml?state=ACTIVE">
                                        <i class="fa fa-user"></i>#{msg.locateUserLbl}</a>
                                </li>
                                <li>
                                    <a><i class="fa fa-cogs"></i>#{msg.reportsSectionLbl} <span class="fa fa-chevron-down"></span></a>
                                    <ul class="nav child_menu">
                                        <li>
                                            <a href="#{request.contextPath}/dashBoardLbl">#{msg.dashBoardLbl}</a>
                                        </li>
                                        <li>
                                            <a href="#{request.contextPath}/bankListLbl">#{msg.bankListLbl}</a>
                                        </li>
                                        <li>
                                            <a href="#{request.contextPath}/currencyIssued">#{msg.currencyIssued}</a>
                                        </li>
                                        <li>
                                            <a href="#{request.contextPath}/systemBalanceLbl">#{msg.systemBalanceLbl}</a>
                                        </li>
                                        <li>
                                            <a href="#{request.contextPath}/currentWeekLbl">#{msg.currentWeekLbl}</a>
                                        </li>
                                        <li>
                                            <a href="#{request.contextPath}/validationToolMsg">#{msg.validationToolMsg}</a>
                                        </li>
                                    </ul>
                                </li>
                                <li>
                                    <a><i class="fa fa-info"></i>#{msg.docsLbl} <span class="fa fa-chevron-down"></span></a>
                                    <ul class="nav child_menu">
                                        <li>
                                            <a href="#{request.contextPath}/docs/incomes.xhtml">#{msg.incomesLbl}</a>
                                        </li>
                                        <li>
                                            <a href="#{request.contextPath}/docs/accounts.xhtml">#{msg.accountsLbl}</a>
                                        </li>
                                        <li>
                                            <a href="#{request.contextPath}/docs/messages.xhtml">#{msg.messageLbl}s</a>
                                        </li>
                                        <li>
                                            <a href="https://github.com/votingsystem/votingsystem" target="_blank">#{msg.proyectLbl}</a>
                                        </li>
                                    </ul>
                                </li>
                            </ul>
                        </div>
                    </div>
                    <!-- /sidebar menu -->
                </div>
            </div>

            <!-- top navigation -->
            <div class="top_nav">
                <div class="nav_menu" style="display: block;">
                    <nav role="navigation">
                        <div class="nav toggle" style="padding: 8px 0 0 0;">
                            <a id="menu_toggle" class="custom-button" style="color: #f2f2f2;"><i class="fa fa-bars"></i></a>
                        </div>
                        <div style="display: flex; flex-direction: row;color: #f2f2f2;">
                            <div id="mainPageCaption" style="width: 100%; text-align: center;font-size: 1.8em;"></div>
                            <div id="authenticatedUserButtonDiv" style="display: none;margin: 0 10px 0 0; color: #f2f2f2;
                                    cursor: pointer;align-self: center;font-weight: bold;">
                                <ul class="nav navbar-nav navbar-right">
                                    <li class="custom-button">
                                        <span data-toggle="dropdown" aria-expanded="false" style="margin: 0 10px 0 0;vertical-align: baseline;
                                                overflow: hidden;white-space: nowrap;">
                                            <i class="fa fa-user"></i><span id="authenticatedUserName" style="margin: 0 0 0 3px;"></span>
                                        </span>
                                        <ul class="dropdown-menu dropdown-usermenu pull-right">
                                            <li onclick="setUserAuthenticated(false)">
                                                <a href="#"><i class="fa fa-sign-out pull-right"></i>#{msg.quitLbl}</a>
                                            </li>
                                        </ul>
                                    </li>
                                </ul>
                            </div>
                            <div id="accessCodeButtonDiv" class="custom-button" style="margin: 0 10px 0 0;vertical-align: baseline;
                                align-self: center;cursor: pointer;font-weight: bold;font-size: 1.1em;width: 90px;" onclick="showAccessCode()">
                                <i class="fa fa-user" aria-hidden="true"></i> #{msg.accessLbl}
                            </div>
                        </div>
                    </nav>
                </div>
            </div>
            <!-- /top navigation -->
            <!-- page content -->
            <div class="right_col" role="main">
                <div class="">
                    <div class="row">
                        <div class="col-md-12 col-sm-12 col-xs-12">
                            <div class="dashboard_graph x_panel">
                                <ui:insert name="content"/>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>
        //<![CDATA[

        var isUserAuthenticated = false;
        function showAccessCode() {
            var userUUID = "#{socketBean.getUserUUID()}";
            vs.showQR('#{msg.readQRMsg}', userUUID.substring(0, 4).toUpperCase(), '#{pageBean.getAccessCodeQR()}')
            console.log("pageBean.getAccessCodeQR: #{pageBean.getAccessCodeQR()}")
            setUserAuthenticated(!isUserAuthenticated);
        }

        function setUserAuthenticated(isUserAuthenticated, userName) {
            if(isUserAuthenticated) {
                if(userName)
                    document.querySelector("#authenticatedUserName").innerHTML = userName;
                document.querySelector("#accessCodeButtonDiv").style.display = 'none';
                document.querySelector("#authenticatedUserButtonDiv").style.display = 'block';
            } else {
                document.querySelector("#accessCodeButtonDiv").style.display = 'block';
                document.querySelector("#authenticatedUserButtonDiv").style.display = 'none';

                var socketMsgDto = {operation:{type:"CLOSE_SESSION"}, uuid:vs.getUUID()};
                vs.rsaUtil.sign(JSON.stringify(socketMsgDto), function(cmsSignedMessage) {
                    var cmsSignedMessage = forge.pkcs7.messageToPem(cmsSignedMessage);
                    console.log("cmsSignedMessage: ", cmsSignedMessage)

                    vs.httpPost(vs.entityId + "/api/device/close-session", function (responseText, status) {
                        console.log("status: " + status + " - responseText: " + responseText);
                    }, cmsSignedMessage, "application/pkcs7-signature");
                })

            }
        }

        function serviceUpdated(updateMessage) {
            var jsonMessage = toJSON(updateMessage);
            console.log("serviceUpdated - jsonMessage: ", jsonMessage);

            var operationType;
            if(jsonMessage.operation)
                operationType = jsonMessage.operation.type;
            else operationType = jsonMessage.socketOperation;

            switch (operationType) {
                case "BROWSER_CERTIFICATION":
                    if(ResponseDto.SC_OK === jsonMessage.statusCode) {
                        vs.rsaUtil.initCSR(jsonMessage.browserCsrSigned);
                        jsonMessage.privateKeyPEM = vs.rsaUtil.privateKeyPEM;
                        jsonMessage.x509CertificatePEM = vs.rsaUtil.x509CertificatePEM;
                        jsonMessage.userName = jsonMessage.user.givenName + " " + jsonMessage.user.surName;
                        pkiSessionDataMap[sessionId] = jsonMessage;
                        //session storage doesn't work with multiple tabs on IExplorer
                        localStorage.setItem('pkiSessionData', JSON.stringify(pkiSessionDataMap));
                        setUserAuthenticated(true, jsonMessage.userName);
                    }
                    break;
                case "MSG_TO_DEVICE":
                    if(vs.rsaUtil) vs.rsaUtil.decryptSocketMsg(jsonMessage)

                    break;
            }
        }

        var pkiSessionDataMap;
        if(localStorage.getItem('pkiSessionData')) {
            try {
                pkiSessionDataMap = toJSON(localStorage.getItem('pkiSessionData'));
            } catch(e) {
                console.log("exception: ", e);
                localStorage.setItem('pkiSessionData', null);
            }
        }
        if(!pkiSessionDataMap)
            pkiSessionDataMap = {};
        console.log("pkiSessionDataMap: ", pkiSessionDataMap);

        vs.userUUID = "#{socketBean.getUserUUID()}";
        var sessionId = vs.getCookie("JSESSIONID");
        console.log("sessionId: " + sessionId + " - userUUID: " + vs.userUUID);

        if(pkiSessionDataMap[sessionId] == null) {
            pkiSessionDataMap = {}
            localStorage.setItem('pkiSessionData', null);
            console.log("deleting previous sessions");
        }

        console.log("after cleaning pkiSessionDataMap: ", pkiSessionDataMap);

        if(Object.keys(pkiSessionDataMap).length === 0) {
            vs.rsaUtil = new RSAUtil(1024);
            var userDataFromCert = {serialName: vs.userUUID}
            var browserCsr = vs.rsaUtil.getCSR(userDataFromCert);
            console.log("browserCsr: ", browserCsr);
            var browserCsrRequest = {browserCsr:browserCsr, userUUID:vs.userUUID};
            vs.httpPost("#{request.contextPath}/api/device/browser-csr", function(responseText, status) {
                console.log("responseText: " + responseText + " - status: " + status);
            }, JSON.stringify(browserCsrRequest));
        } else {
            var sessionData = pkiSessionDataMap[sessionId];
            vs.rsaUtil = new RSAUtil(null, sessionData.privateKeyPEM, sessionData.x509CertificatePEM);
            setUserAuthenticated(true, sessionData.userName);
        }

        //]]>
    </script>
    <script src="#{request.contextPath}/res/js/custom.min.js"></script>
    <o:socket channel="testChannel" user="#{socketBean.getUserUUID()}" onmessage="serviceUpdated"/>
</h:body>
</html>