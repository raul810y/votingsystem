<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:ui="http://java.sun.com/jsf/facelets"
                template="/WEB-INF/templates/basic.xhtml">
    <ui:define name="head">
        <meta name="viewport" content="width=device-width, initial-scale=1"/>
        <meta name="mobile-web-app-capable" content="yes"/>
        <meta name="application-name" content="VotingSystem"/>
        <meta name="apple-mobile-web-app-capable" content="yes" />
        <link rel="shortcut icon" type="image/png" href="./resources/images/icon_16/fa-money.png" />
        <title><ui:insert name="title" /></title>
        <link href="./resources/bower_components/font-awesome/css/font-awesome.min.css" media="all" rel="stylesheet" />
        <link href="./resources/css/currency.css" media="all" rel="stylesheet" />
        <script src="./resources/bower_components/webcomponentsjs/webcomponents-lite.js"></script>
        <link rel="import" href="./resources/bower_components/polymer/polymer.html"/>
        <link rel="import" href="./resources/bower_components/layout/layout.html"/>
        <script src="./resources/js/utils_js.vsp" type="text/javascript"></script>
        <script src="./resources/js/utils.js" type="text/javascript"></script>
        <link rel="import" href="./resources/routing.xhtml"/>
    </ui:define>
    <ui:define name="content">
        <div id="spaMainDiv" style="display: none;">
        <div id="drawer" style="display: none;">
            <div style="background-color: #ba0011; color: #f9f9f9;">
                <div id="pageTitle" style="padding: 8px 0 8px 15px;font-size: 1.8em;"></div>
            </div>
            <div class="vertical layout flex" style="background-color: #fefefe;">
                <a class="menuItem menuItemSelected" data-route="home" href="#{contextURL}#!/home">
                    <i class="fa fa-home"></i> ${msg.homeLbl}
                </a>
                <a class="menuItem menuItemSelected" data-route="user" href="#{contextURL}#!/user/search">
                    <i class="fa fa-user"></i> ${msg.locateUserLbl}
                </a>
                <a class="menuItem menuItemSelected isAdminView" data-route="newBank" href="#{contextURL}#!/innerVSPage?url=/user/newBank.xhtml&amp;caption=${msg.newBankLbl}&amp;data_route=newBank">
                    <i class="fa fa-university"></i> ${msg.newBankLbl}
                </a>
                <a class="menuItem menuItemSelected isAdminView" data-route="x509Certificate" href="#{contextURL}#!/x509Certificate/certs">
                    <i class="fa fa-users"></i> ${msg.locateCertLbl}
                </a>
                <a class="menuItem menuItemSelected" data-route="reports" href="#{contextURL}#!/reports">
                    <i class="fa fa-cogs"></i> ${msg.reportsSectionLbl}
                </a>
                <a class="menuItem menuItemSelected" data-route="docs" href="#{contextURL}#!/innerVSPage?url=/app/index.xhtml&amp;caption=${msg.docsLbl}&amp;data_route=docs">
                    <i class="fa fa-info"></i> ${msg.docsLbl}
                </a>
                <a class="menuItem menuItemSelected" data-route="contact" href="#{contextURL}#!/app/contact">
                    <i class="fa fa-phone"></i> ${msg.contactLbl}
                </a>
            </div>
        </div>
        <div id='main'>
            <div class="horizontal layout flex" style="background-color: #ba0011;box-shadow: 0 3px 3px 0 #ccc;
                    padding: 1px 0 1px 0;width:100%;">
                <div style="margin:0 30px 0 30px;">
                    <i id="drawerButton" class="fa fa-navicon navbarIcon" style="font-size: 1.7em; margin:3px 0 0 0;"></i>
                </div>
                <div class="flex" style="font-size: 1.7em;color: #f9f9f9;text-align: center;" id="selectedPageTitle"></div>
                <div id="connectionMsgDiv" class="navbarIcon" style="font-size: 1.2em;margin:3px 30px 0 0;">
                    #{msg.accessLbl}
                </div>
            </div>
            <p id="pageInfoPanel" class="text-center" style="margin: 20px auto 20px auto; font-size: 1.3em;
                        background-color: #f9f9f9; max-width: 1000px; padding: 10px; display: none;"></p>
            <div id="mainContent" class="mainContent"></div>
        </div>
        </div>
        <script>
            //<![CDATA[
            window.addEventListener('WebComponentsReady', function() {
                vs.back = function() {
                    history.back()
                    //there's a delay until location.href is updated with history.back()
                    setTimeout(function () { page(window.location.href.split("\\#!")[1]) }, 50);
                }
                var rightClickHandle = function(e) {
                    if(vs.connectedDevice) {
                        e.target.setAttribute('href', vs.updateQueryStringParameter(e.target.href, "iv_id",
                                vs.aesParams.iv_id));
                    }
                };
                function updateLinksVS(elementsArray) {
                    for (var i = 0; i < elementsArray.length; i++) {
                        if(elementsArray[i].href.indexOf("#{contextURL}") > -1) {
                            elementsArray[i].addEventListener('contextmenu', rightClickHandle);
                        }
                    }
                }
                document.querySelector("#drawerButton").addEventListener('click', function (event) {
                    document.querySelector("#drawer").style.display = 'block'
                    event.stopPropagation();
                }, true);
                document.querySelector("#voting_system_page").addEventListener('click', function (event) {
                    document.querySelector("#drawer").style.display = 'none'
                });
                document.querySelector("#voting_system_page").addEventListener('connected', function (event) {
                    page.show(vs.contextURL + "/rest/balance/user" + new Date().getURL('WEEK'))
                    document.querySelector("#connectionMsgDiv").innerText = "${msg.disConnectLbl}"
                });
                document.querySelector("#voting_system_page").addEventListener('disconnected', function (event) {
                    page.show("/home")
                    document.querySelector("#connectionMsgDiv").innerText = "${msg.accessLbl}"
                });
                document.querySelector("#connectionMsgDiv").addEventListener('click', function (event) {
                    if(vs.connected !== true) {
                        vs.showAccessQRCode()
                    } else {
                        alert("#{msg.quitConfirmMsg}", "#{msg.messageLbl}", function() {
                            var operation = {operation:'CLOSE_SESSION', UUID:vs.getUUID(),
                                httpSessionId:vs.getCookie("JSESSIONID")}
                            vs.rsaUtil.signAndPost(vs.contextURL + "/rest/device/closeSession", operation, function(responseText){
                                vs.setDisConnected();
                            })
                        })
                    }
                });
                vs.updateMenuView = function() {
                    var appTitle = "${msg.appTitle}"
                    var adminElements = document.querySelectorAll(".isAdminView");
                    for (var i = 0; i < adminElements.length; ++i) {
                        adminElements[i].style.display = "none";
                    }
                    if('admin' === menuType) {
                        for (var i = 0; i < adminElements.length; ++i) {
                            adminElements[i].style.display = "block";
                        }
                        appTitle = "${msg.adminPageTitle}"
                    }
                    document.querySelector("#pageTitle").innerText = appTitle
                }
                vs.loadMainContent = function(newContentNode, caption, searchVisible) {
                    if(caption) sendSignalVS({caption:caption})
                    var mainContentNode = document.getElementById("mainContent")
                    if(mainContentNode.childNodes[0]) mainContentNode.removeChild(mainContentNode.childNodes[0])
                    mainContentNode.appendChild(newContentNode)
                    if('admin' === menuType) caption = caption + ' - ${msg.adminLbl}'
                    var menuItems = document.querySelectorAll("#drawer .menuItem")
                    for(var i = 0; i < menuItems.length ; i++) {
                        if(menuItems[i].getAttribute("data-route") === vs.route) {
                            menuItems[i].classList.add("menuItemSelected");
                        } else menuItems[i].classList.remove("menuItemSelected");
                    }
                    updateLinksVS(newContentNode.querySelectorAll("a"))
                    if(vs.connectedDevice) {
                        history.pushState(null, null, vs.updateQueryStringParameter(
                                window.location.href, "iv_id", vs.aesParams.iv_id));
                    }
                }
                vs.updateSearchMessage = function(searchMessage) {
                    if(searchMessage) {
                        document.querySelector("#pageInfoPanel").innerHTML = searchMessage
                        document.querySelector("#pageInfoPanel").style.display = "block"
                    } else document.querySelector("#pageInfoPanel").style.display = "none"
                }
                document.querySelector('#voting_system_page').addEventListener('search-request', function (e) {
                    console.log("search request - query:" + e.detail.query);
                })
                document.querySelector("#voting_system_page").addEventListener('user-clicked', function(e) {
                    console.log("user-clicked")
                    page.show(vs.contextURL + "/rest/user/id/" + e.detail.id + "?connectedDevices=true")
                })
                vs.updateMenuView()
                document.querySelector("#spaMainDiv").style.display = "block"
                var sessionId = vs.getCookie("JSESSIONID");

                updateLinksVS(document.querySelectorAll("a"))

                if(localStorage.getItem('sessionData')) {
                    var sessionDataEncrypted = localStorage.getItem('sessionData');
                    var iv_id = getURLParam("iv_id", window.location.href);

                    document.querySelector("#voting_system_page").addEventListener('SEND_AES_PARAMS', function(e) {
                        var sessionData = toJSON(vs.decryptAES(sessionDataEncrypted, vs.aesParams))
                        console.log("restoring sessionData");
                        vs.rsaUtil = new RSAUtil(null, sessionData.privateKeyPEM, sessionData.x509CertificatePEM)
                        vs.setConnected(sessionData.connectedDevice, null);
                    })
                    if(iv_id) {
                        console.log("restoring session - iv_id: " + iv_id );
                        vs.client.processOperation({qrOperationCode:vs.QROperationCode.GET_AES_PARAMS, msg:iv_id,
                            caption:"${msg.restoreSession}"})
                    }
                }
            })
            //]]>
        </script>
    </ui:define>
</ui:composition>